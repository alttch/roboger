#!/usr/bin/env python3
# PYTHON_ARGCOMPLETE_OK

__author__ = "Altertech Group, http://www.altertech.com/"
__copyright__ = "Copyright (C) 2018 Altertech Group"
__license__ = "See https://www.roboger.com/"
__version__ = "1.0.0"

import os
import sys
import argparse
import json
import jsonpickle
import configparser
import requests
import re

_pd_cols = {
    'ls_subscriptions':
    ['id', 'active', 'level', 'senders', 'location', 'keywords'],
    'ls_endpoints':
    ['id', 'active', 'parameters', 'skip_dups', 'type', 'description'],
    'ls_events': [
        'id', 'd', 'delivered', 'sender', 'subject', 'location', 'keywords',
        'media'
    ]
}

arg_sections = ['addr', 'endpoint', 'subscription', 'event' ]

_level_match_sign = {'g': ' >', 'ge': '>=', 'l': ' <', 'le': '<=', 'e': '='}


def format_json(obj, minimal=False):
    return json.dumps(json.loads(jsonpickle.encode(obj,
            unpicklable = False)), indent = 4, sort_keys = True) \
                if not minimal else jsonpickle.encode(obj, unpicklable = False)


def print_json(obj):
    print(format_json(obj))


def _prepare_result_data(data, func):
    skip_cols = ['data', 'data2', 'data3', 'destroyed']
    j = data.copy()
    result = []
    for i in j:
        try:
            d = i['description']
            if d is not None and d != '':
                i['description'] = '\'' + d + '\''
        except:
            pass
        for sk in skip_cols:
            try:
                del i[sk]
            except:
                pass
        if func in ['ls_endpoints', 'ls_subscriptions']:
            try:
                del i['addr_id']
                del i['endpoint_id']
            except:
                pass
        if func == 'ls_endpoints':
            if result: result.append({})
            i['type'] += ' (%r)' % i['type_id']
            del i['type_id']
            info = []
            for k in sorted(i.copy().keys()):
                if k not in _pd_cols['ls_endpoints']:
                    info.append('%s : %r' % (k, i[k]))
                    del i[k]
            i['id'] = str(i['id'])
            i['active'] = str(i['active'])
            if info:
                i['parameters'] = info[0]
                result.append(i)
                for x in range(1, len(info)):
                    ipar = {'parameters': info[x]}
                    result.append(ipar)
                continue
            else:
                i['parameters'] = ''
        elif func == 'ls_subscriptions':
            i['level'] = _level_match_sign[i['level_match']] + ' ' + i['level']
            i['keywords'] = ','.join(i['keywords'])
            i['senders'] = ','.join(i['senders'])
        elif func == 'ls_events':
            if i['media']: i['media'] = 'YES'
            i['keywords'] = ','.join(i['keywords'])
        result.append(i)
    return result


def pprint_df(data, func):
    pd.options.display.max_colwidth = 65
    df = pd.DataFrame(data=_prepare_result_data(data, func))
    if func in _pd_cols:
        cols = _pd_cols[func]
    else:
        cols = list(df)
        # move description column to the end if exist
        try:
            cols.append(cols.pop(cols.index('description')))
        except:
            pass
    df = df.ix[:, cols]
    try:
        # move id to the header
        df.set_index('id', inplace=True)
        out = df.fillna(' ').to_string().split('\n')
        # print header
        print('id' + out[0][2:])
        # print separator
        print('-' * len(out[0]))
        # print data frame
        [print(re.sub('^NaN', '   ', o)) for o in out[2:]]
    except:
        print(df)


dir_etc = os.path.dirname(os.path.realpath(__file__)) + '/../etc'

default_timeout = 5
apikey = None
apiuri = None

debug = False

xparams = {}

_me = 'Roboger client version %s' % __version__

ap = argparse.ArgumentParser(description=_me)
ap.add_argument('-U','--api-uri',
        help='specify API uri (http://host:port), if no uri specified,' + \
                ' local config will be parsed ', dest='_uri', metavar='URI')
ap.add_argument(
    '-V',
    '--version',
    help='Print version and exit',
    action='store_true',
    dest='_ver')
ap.add_argument(
    '-K',
    '--api-key',
    help='Master key, if no key specified, local master key will be used',
    dest='_key',
    metavar='KEY')
ap.add_argument(
    '-T',
    '--api-timeout',
    help='API request timeout (in seconds)',
    type=float,
    default=default_timeout,
    dest='_timeout',
    metavar='TIMEOUT')
ap.add_argument(
    '-J',
    '--json',
    help='Print result as JSON',
    action='store_true',
    dest='_json',
    default=False)
ap.add_argument(
    '-D',
    '--debug',
    help='Enable debug messages',
    action='store_true',
    dest='_debug',
    default=False)

sp = ap.add_subparsers(
    dest='_type', metavar='command', help='Command to execute')

sp_test = sp.add_parser('test', help='test API')

# address commands
ap_addr = sp.add_parser('addr', help='Address management')
sp_addr = ap_addr.add_subparsers(
    dest='_func', metavar='func', help='Address commands')

sp_addr_list = sp_addr.add_parser('list', help='List address(es)')
sp_addr_list.add_argument(
    '_address', help='Address or address id', nargs='?', metavar='ADDRESS')

sp_addr_creage = sp_addr.add_parser('create', help='Create new address')

sp_addr_change = sp_addr.add_parser('change', help='Change existing address')
sp_addr_change.add_argument(
    '_address', help='Address or address id', metavar='ADDRESS')

sp_addr_enable = sp_addr.add_parser('enable', help='Enable address')
sp_addr_enable.add_argument(
    '_address', help='Address or address id', metavar='ADDRESS')

sp_addr_disable = sp_addr.add_parser('disable', help='Disable address')
sp_addr_disable.add_argument(
    '_address', help='Address or address id', metavar='ADDRESS')

sp_addr_delete = sp_addr.add_parser('delete', help='Delete address')
sp_addr_delete.add_argument(
    '_address', help='Address or address id', metavar='ADDRESS')

# endpoint commands
ap_endpoint = sp.add_parser('endpoint', help='Endpoint management')
sp_endpoint = ap_endpoint.add_subparsers(
    dest='_func', metavar='func', help='Endpoint commands')

sp_ls_endpoint_types = sp_endpoint.add_parser(
    'types', help='List IDs of endpoint types')

sp_ls_endpoints = sp_endpoint.add_parser('list', help='List endpoints')
sp_ls_endpoints.add_argument(
    'endpoint_id', help='Endpoint id', metavar='ID', type=int, nargs='?')
sp_ls_endpoints.add_argument(
    '-a',
    '--address',
    help='Address or address id',
    metavar='ADDRESS',
    dest='_address')

sp_mk_endpoint = sp_endpoint.add_parser('create', help='Create new endpoint')
sp_mk_endpoint.add_argument(
    '_address', help='Address or address ID', metavar='ADDRESS')
sp_mk_endpoint.add_argument(
    'et', help='Endpoint type id', metavar='TYPE_ID', type=int)
sp_mk_endpoint.add_argument(
    'data', help='Endpoint data (email, url, webhook, chat id etc.)')
sp_mk_endpoint.add_argument(
    '--data2',
    help='Endpoint data 2 ("rich" for slack endpoint to send rich format)')
sp_mk_endpoint.add_argument(
    '--data3', help='Endpoint data 3 (params for http endpoints)')
sp_mk_endpoint.add_argument('-o', '--description', help='Endpoint description')

sp_endpoint_enable = sp_endpoint.add_parser(
    'enable', help='Enable endpoint')
sp_endpoint_enable.add_argument(
    'endpoint_id', help='Endpoint id', metavar='ID', type=int)
sp_endpoint_enable.add_argument(
    '-a',
    '--address',
    help=argparse.SUPPRESS,
    metavar='ADDRESS',
    dest='_address')

sp_endpoint_disable = sp_endpoint.add_parser(
    'disable', help='Disable endpoint')
sp_endpoint_disable.add_argument(
    'endpoint_id', help='Endpoint id', metavar='ID', type=int)
sp_endpoint_disable.add_argument(
    '-a',
    '--address',
    help=argparse.SUPPRESS,
    metavar='ADDRESS',
    dest='_address')

sp_set_endpoint_data = sp_endpoint.add_parser(
    'data', help='Set endpoint data params')
sp_set_endpoint_data.add_argument(
    'endpoint_id', help='Endpoint id', metavar='ID', type=int)
sp_set_endpoint_data.add_argument(
    '-a',
    '--address',
    help=argparse.SUPPRESS,
    metavar='ADDRESS',
    dest='_address')
sp_set_endpoint_data.add_argument(
    'data', help='Endpoint data (email, url, webhook, chat id etc.)')
sp_set_endpoint_data.add_argument(
    '--data2',
    help='Endpoint data 2 ("rich" for slack endpoint to send rich format)')
sp_set_endpoint_data.add_argument(
    '--data3', help='Endpoint data 3 (params for http endpoints)')

sp_set_endpoint_description = sp_endpoint.add_parser(
    'description', help='Set endpoint description')
sp_set_endpoint_description.add_argument(
    'endpoint_id', help='Endpoint id', metavar='ID', type=int)
sp_set_endpoint_description.add_argument(
    '-a',
    '--address',
    help=argparse.SUPPRESS,
    metavar='ADDRESS',
    dest='_address')
sp_set_endpoint_description.add_argument(
    'description', help='Endpoint description', nargs='?')

sp_set_endpoint_skip_dups = sp_endpoint.add_parser(
    'dups', help='Set endpoint skip_dups')
sp_set_endpoint_skip_dups.add_argument(
    'endpoint_id', help='Endpoint id', metavar='ID', type=int)
sp_set_endpoint_skip_dups.add_argument(
    'data', help='Skip dups time (in sec)', metavar='DELAY', type=int)
sp_set_endpoint_skip_dups.add_argument(
    '-a',
    '--address',
    help=argparse.SUPPRESS,
    metavar='ADDRESS',
    dest='_address')

sp_rm_endpoint = sp_endpoint.add_parser('delete', help='Delete endpoint')
sp_rm_endpoint.add_argument(
    'endpoint_id', help='Endpoint id', metavar='ID', type=int)
sp_rm_endpoint.add_argument(
    '-a',
    '--address',
    help=argparse.SUPPRESS,
    metavar='ADDRESS',
    dest='_address')

# subscription commands
ap_subscription = sp.add_parser('subscription', help='Subscription management')
sp_subscription = ap_subscription.add_subparsers(
    dest='_func', metavar='func', help='Subscription commands')

sp_ls_subscriptions = sp_subscription.add_parser(
    'list', help='List subscriptions')
sp_ls_subscriptions.add_argument(
    'subscription_id',
    help='subscription id',
    metavar='ID',
    type=int,
    nargs='?')
sp_ls_subscriptions.add_argument(
    '-a',
    '--address',
    help=argparse.SUPPRESS,
    metavar='ADDRESS',
    dest='_address')
sp_ls_subscriptions.add_argument(
    'endpoint_id', help='Endpoint id', type=int, metavar='ENDPOINT_ID')

sp_mk_subscription = sp_subscription.add_parser(
    'create', help='Create new subscription')
sp_mk_subscription.add_argument(
    'endpoint_id', help='Endpoint id', metavar='ENDPOINT_ID', type=int)
sp_mk_subscription.add_argument(
    '-a',
    '--address',
    help=argparse.SUPPRESS,
    metavar='ADDRESS',
    dest='_address')
sp_mk_subscription.add_argument('-n', '--location', help='Event location')
sp_mk_subscription.add_argument(
    '-k', '--keywords', help='Keywords, comma separated')
sp_mk_subscription.add_argument(
    '-x', '--senders', help='Senders, comma separated')
sp_mk_subscription.add_argument(
    '-l', '--level', help='Subscription level', dest='_level')
sp_mk_subscription.add_argument(
    '-m',
    '--level-match',
    help=
    'Subscription level match ' + \
            '(ge for >=, le for <=, l for <, g for >, e for =)',
    choices=['ge', 'le', 'l', 'g', 'e'])

sp_subscription_enable = sp_subscription.add_parser(
    'enable', help='Enable subscription')
sp_subscription_enable.add_argument(
    'subscription_id', help='Subscription id', metavar='ID', type=int)
sp_subscription_enable.add_argument(
    '-a',
    '--address',
    help=argparse.SUPPRESS,
    metavar='ADDRESS',
    dest='_address')

sp_subscription_disable = sp_subscription.add_parser(
    'disable', help='Disable subscription')
sp_subscription_disable.add_argument(
    'subscription_id', help='Subscription id', metavar='ID', type=int)
sp_subscription_disable.add_argument(
    '-a',
    '--address',
    help=argparse.SUPPRESS,
    metavar='ADDRESS',
    dest='_address')

sp_set_subscription_location = sp_subscription.add_parser(
    'location', help='Set subscription location')
sp_set_subscription_location.add_argument(
    'subscription_id', help='Subscription id', metavar='ID', type=int)
sp_set_subscription_location.add_argument(
    'location', help='Event location', nargs='?')
sp_set_subscription_location.add_argument(
    '-a',
    '--address',
    help=argparse.SUPPRESS,
    metavar='ADDRESS',
    dest='_address')

sp_set_subscription_keywords = sp_subscription.add_parser(
    'keywords', help='Set subscription keywords')
sp_set_subscription_keywords.add_argument(
    'subscription_id', help='Subscription id', metavar='ID', type=int)
sp_set_subscription_keywords.add_argument(
    'keywords', help='Keywords, comma separated', nargs='?')
sp_set_subscription_keywords.add_argument(
    '-a',
    '--address',
    help=argparse.SUPPRESS,
    metavar='ADDRESS',
    dest='_address')

sp_set_subscription_senders = sp_subscription.add_parser(
    'senders', help='set subscription senders')
sp_set_subscription_senders.add_argument(
    'subscription_id', help='Subscription id', metavar='ID', type=int)
sp_set_subscription_senders.add_argument(
    'senders', help='Senders, comma separated', nargs='?')
sp_set_subscription_senders.add_argument(
    '-a',
    '--address',
    help=argparse.SUPPRESS,
    metavar='ADDRESS',
    dest='_address')

sp_set_subscription_level = sp_subscription.add_parser(
    'level', help='Set subscription level')
sp_set_subscription_level.add_argument(
    'subscription_id', help='Subscription id', metavar='ID', type=int)
sp_set_subscription_level.add_argument(
    '_level', help='Subscription level', nargs='?', metavar='level')
sp_set_subscription_level.add_argument(
    '-m',
    '--level-match',
    help=
    'Subscription level match (ge for >=, le for <=, l for <, g for >, e for =)',
    choices=['ge', 'le', 'l', 'g', 'e'])
sp_set_subscription_level.add_argument(
    '-a',
    '--address',
    help=argparse.SUPPRESS,
    metavar='ADDRESS',
    dest='_address')

sp_rm_subscription = sp_subscription.add_parser(
    'delete', help='delete subscription')
sp_rm_subscription.add_argument(
    'subscription_id', help='Subscription id', metavar='ID', type=int)
sp_rm_subscription.add_argument(
    '-a',
    '--address',
    help=argparse.SUPPRESS,
    metavar='ADDRESS',
    dest='_address')

# subscription copy functions
sp_copy_subscription = sp_subscription.add_parser(
    'duplicate', help='Copy subsciption to a new one')
sp_copy_subscription.add_argument(
    'subscription_id', help='subscription id', metavar='ID', type=int)
sp_copy_subscription.add_argument(
    '-a',
    '--address',
    help=argparse.SUPPRESS,
    metavar='ADDRESS',
    dest='_address')

sp_copy_endpoint_subscriptions = sp_endpoint.add_parser(
    'copysub',
    help=
    'Delete target endpoint subscriptions and copy' + \
        ' source endpoint subscriptions to it'
)
sp_copy_endpoint_subscriptions.add_argument(
    'endpoint_id',
    help='source endpoint id',
    metavar='SOURCE_ENDPOINT_ID',
    type=int)
sp_copy_endpoint_subscriptions.add_argument(
    'endpoint_id_t',
    help='target endpoint id',
    metavar='TARGET_ENDPOINT_ID',
    type=int)
sp_copy_endpoint_subscriptions.add_argument(
    '-a',
    '--address',
    help=argparse.SUPPRESS,
    metavar='ADDRESS',
    dest='_address')

# ls events
ap_event = sp.add_parser('event', help='Event management')
sp_event = ap_event.add_subparsers(
    dest='_func', metavar='func', help='Event commands')

sp_ls_events = sp_event.add_parser('list', help='List events (if stored)')
sp_ls_events.add_argument(
    '_address', help='Address or address id', metavar='ADDRESS')
sp_ls_events.add_argument(
    '-n', '--limit', help='limit output to N events', metavar='N', type=int)

try:
    import argcomplete
    argcomplete.autocomplete(ap)
except:
    pass

a = ap.parse_args()

if a._ver:
    print(_me)
    sys.exit()

apiuri = a._uri
apikey = a._key

debug = a._debug

itype = a._type
if hasattr(a, '_func'):
    func = a._func
else:
    func = None

timeout = a._timeout

for k, v in vars(a).items():
    if k and k[0] != '_' and v is not None:
        xparams[k] = v

if hasattr(a, '_address') and a._address:
    try:
        xparams['addr_id'] = int(a._address)
    except:
        xparams['addr'] = a._address

if hasattr(a, '_level') and a._level is not None:
    try:
        xparams['level_id'] = int(a._level)
    except:
        xparams['level'] = a._level

if itype in arg_sections and not func:
    ap.parse_args([itype, '--help'])

api_func = itype + ('_' + func if func else '')

if not api_func:
    ap.print_usage()
    sys.exit(2)

if not apiuri or not apikey:
    cfg = configparser.ConfigParser(inline_comment_prefixes=';')
    cfg.read(dir_etc + '/roboger.ini')
    if not apikey:
        try:
            apikey = cfg.get('api', 'masterkey')
        except:
            pass
    if not apiuri:
        try:
            l = cfg.get('api', 'listen')
            proto = 'http'
        except:
            try:
                l = cfg.get('api', 'ssl_listen')
                proto = 'https'
            except:
                l = None
        if l:
            try:
                host, port = l.split(':')
            except:
                host = l
                port = '80'
            if host == '0.0.0.0': host = '127.0.0.1'
            apiuri = '%s://%s:%s' % (proto, host, port)
    try:
        development = (cfg.get('server', 'development') == 'yes')
        if development: debug = True
    except:
        pass

if not apiuri:
    print('no API URI specified')
    sys.exit(5)

if not apikey:
    print('no API masterkey specified')
    sys.exit(6)


def api_call(func, params):
    apiuri_r = apiuri + '/manage/' + func
    if debug:

        print("API request: %s" % apiuri_r)
        print("API max timeout: %u sec" % timeout)
        print("API requsts params:")
        print_json(params)
        print()
    xp = params.copy()
    xp['k'] = apikey
    try:
        r = requests.post(apiuri_r, json=xp, timeout=timeout)
    except:
        print('API error: can not connect (%s)' % apiuri)
        sys.exit(1)
    return r


r = api_call(api_func, xparams)

if debug:
    print("API response code: %s" % r.status_code)
if r.status_code == 200:
    try:
        j = jsonpickle.decode(r.text)
    except:
        print('API error: invalid json response')
        sys.exit(3)
    if a._json:
        print_json(j)
    else:
        if isinstance(j, dict):
            rprinted = False
            for v in sorted(j.keys()):
                if v != 'result':
                    print(("{:>%u} : {}" % max(map(len, j))).format(v, j[v]))
                    rprinted = True
            if not rprinted:
                print('OK')
        elif isinstance(j, list):
            if j:
                import pandas as pd
                pprint_df(j, api_func)
            else:
                print('no data')
        else:
            print(j)
else:
    print("API error %u" % (r.status_code))
    if debug: print(r.text)
    sys.exit(2)
